<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WatchParty Pro üé¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #8b5cf6; }
        body { background-color: #020617; color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .progress-bar { height: 4px; border-radius: 2px; background: rgba(255,255,255,0.1); overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #d946ef); transition: width 0.5s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .log-panel { font-family: monospace; font-size: 10px; max-height: 120px; overflow-y: auto; background: #000; color: #22c55e; padding: 8px; }
    </style>
</head>
<body>

<div id="app"></div>

<script>
const DB_URL = "https://watchpartychou-default-rtdb.europe-west1.firebasedatabase.app/collection.json";
const API_BASE = "https://imdbapi.dev";

let state = {
    view: 'films', // films, series, search
    filter: 'recent', // recent, rating
    query: '',
    results: [],
    collection: [],
    loading: true,
    searching: false,
    showLogs: false,
    logs: [],
    ratingModal: null // {item, type, epData}
};

function addLog(m) {
    state.logs.unshift(`[${new Date().toLocaleTimeString()}] ${m}`);
    render();
}

// --- LOGIQUE DONN√âES ---
async function fetchData() {
    try {
        const r = await fetch(DB_URL);
        state.collection = await r.json() || [];
        addLog("Sync termin√©e (" + state.collection.length + ")");
    } catch (e) { addLog("Erreur Sync: " + e.message); }
    state.loading = false;
    render();
}

async function save() {
    try {
        await fetch(DB_URL, { method: 'PUT', body: JSON.stringify(state.collection) });
    } catch (e) { addLog("Erreur Save: " + e.message); }
}

// --- RECHERCHE (imdbapi.dev) ---
async function search() {
    if(!state.query.trim()) return;
    state.searching = true;
    render();
    addLog("Recherche IMDB...");
    try {
        const r = await fetch(`${API_BASE}/search?q=${encodeURIComponent(state.query)}`);
        const data = await r.json();
        state.results = data.results || [];
        addLog(state.results.length + " trouv√©s");
    } catch (e) { addLog("Erreur API: " + e.message); }
    state.searching = false;
    render();
}

// --- ACTIONS ---
function addToCollection(item, rating) {
    const exists = state.collection.find(i => i.id === item.id);
    if (!exists) {
        const newItem = {
            id: item.id,
            title: item.title,
            year: item.year,
            image: item.image,
            type: item.type === 'movie' ? 'movie' : 'series',
            rating: rating,
            addedAt: Date.now(),
            episodes: [] // Format: {s:1, e:5, r:4}
        };
        state.collection.unshift(newItem);
    } else {
        exists.rating = rating;
    }
    save();
    state.ratingModal = null;
    state.view = item.type === 'movie' ? 'films' : 'series';
    render();
}

function noteEpisode(itemId, s, e, r) {
    const item = state.collection.find(i => i.id === itemId);
    if (item) {
        const idx = item.episodes.findIndex(ep => ep.s === s && ep.e === e);
        if (idx > -1) item.episodes[idx].r = r;
        else item.episodes.push({s, e, r});
        save();
    }
    state.ratingModal = null;
    render();
}

// --- COMPOSANTS UI ---
function render() {
    const app = document.getElementById('app');
    if(state.loading) {
        app.innerHTML = `<div class="h-screen flex items-center justify-center animate-pulse text-purple-500 text-4xl">üé¨</div>`;
        return;
    }

    // Filtrage et Tri
    let list = state.collection.filter(i => state.view === 'films' ? i.type === 'movie' : i.type === 'series');
    if(state.filter === 'rating') list.sort((a,b) => b.rating - a.rating);
    else list.sort((a,b) => b.addedAt - a.addedAt);

    app.innerHTML = `
        <header class="glass sticky top-0 z-50 p-4 flex justify-between items-center">
            <h1 class="text-xl font-black bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">WATCHPARTY</h1>
            <button onclick="state.showLogs=!state.showLogs;render()" class="text-[10px] opacity-50">LOGS</button>
        </header>

        ${state.showLogs ? `<div class="log-panel">${state.logs.map(l=>`<div>${l}</div>`).join('')}</div>` : ''}

        <nav class="flex p-4 gap-2 overflow-x-auto no-scrollbar">
            ${['films', 'series', 'search'].map(v => `
                <button onclick="state.view='${v}';render()" class="px-6 py-2 rounded-full text-sm font-bold transition-all ${state.view === v ? 'bg-purple-600 shadow-lg shadow-purple-900/40' : 'bg-slate-800 text-slate-400'}">
                    ${v.toUpperCase()}
                </button>
            `).join('')}
        </nav>

        <main class="p-4 pb-24">
            ${state.view === 'search' ? renderSearch() : `
                <div class="flex gap-4 mb-6 text-xs font-bold text-slate-500">
                    <button onclick="state.filter='recent';render()" class="${state.filter==='recent'?'text-white':''}">R√âCENTS</button>
                    <button onclick="state.filter='rating';render()" class="${state.filter==='rating'?'text-white':''}">MIEUX NOT√âS</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    ${list.map(renderCard).join('')}
                </div>
            `}
        </main>

        ${state.ratingModal ? renderRatingModal() : ''}
    `;
}

function renderCard(item) {
    const progress = item.type === 'series' ? Math.min((item.episodes.length / 12) * 100, 100) : 0; // Estimation 12 ep/saison
    return `
        <div class="glass rounded-2xl overflow-hidden flex flex-col group">
            <div class="relative aspect-[2/3]">
                <img src="${item.image}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent p-3 flex flex-col justify-end">
                    <div class="flex text-yellow-400 text-xs">${'‚òÖ'.repeat(item.rating)}</div>
                </div>
                <button onclick="deleteItem('${item.id}')" class="absolute top-2 right-2 p-2 bg-black/40 rounded-full text-[10px]">üóëÔ∏è</button>
            </div>
            <div class="p-3">
                <h3 class="text-xs font-bold truncate mb-2">${item.title}</h3>
                ${item.type === 'series' ? `
                    <div class="progress-bar mb-1"><div class="progress-fill" style="width:${progress}%"></div></div>
                    <div class="flex justify-between text-[8px] text-slate-500 font-bold uppercase">
                        <span>Progression</span>
                        <span>${item.episodes.length} EP</span>
                    </div>
                    <button onclick="openNoteEp('${item.id}')" class="w-full mt-3 py-2 bg-white/5 rounded-lg text-[10px] font-bold">+ √âPISODE</button>
                ` : ''}
            </div>
        </div>
    `;
}

function renderSearch() {
    return `
        <div class="flex gap-2 mb-8">
            <input type="text" oninput="state.query=this.value" onkeypress="if(event.key==='Enter')search()" 
                class="flex-1 bg-slate-800 rounded-xl px-4 py-3 outline-none focus:ring-2 ring-purple-500" placeholder="Rechercher un titre...">
            <button onclick="search()" class="bg-purple-600 px-6 rounded-xl">üîç</button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            ${state.results.map(r => `
                <div onclick="state.ratingModal={item:${JSON.stringify(r).replace(/"/g, '&quot;')}, type:'movie'};render()" class="glass p-2 rounded-xl text-center">
                    <img src="${r.image}" class="rounded-lg aspect-[2/3] object-cover mb-2">
                    <div class="text-[10px] font-bold truncate">${r.title}</div>
                    <div class="text-[9px] text-purple-400 uppercase mt-1">Ajouter</div>
                </div>
            `).join('')}
        </div>
        ${state.searching ? '<div class="text-center p-10 animate-pulse">Chargement...</div>' : ''}
    `;
}

function renderRatingModal() {
    const {item, type} = state.ratingModal;
    return `
        <div class="fixed inset-0 z-[100] glass flex items-center justify-center p-6">
            <div class="bg-slate-900 border border-white/10 w-full max-w-xs rounded-3xl p-6 shadow-2xl">
                <h2 class="text-center font-bold mb-2">${item.title || 'Noter'}</h2>
                <p class="text-center text-[10px] text-slate-500 mb-6 uppercase tracking-widest">Combien d'√©toiles ?</p>
                <div class="flex justify-center gap-2 mb-8 text-2xl">
                    ${[1,2,3,4,5].map(n => `<button onclick="confirmNote(${n})" class="hover:scale-125 transition-transform">‚òÖ</button>`).join('')}
                </div>
                <button onclick="state.ratingModal=null;render()" class="w-full py-3 text-sm text-slate-500 font-bold">ANNULER</button>
            </div>
        </div>
    `;
}

function openNoteEp(id) {
    const s = prompt("Saison ?", "1");
    const e = prompt("√âpisode ?", "1");
    if(s && e) state.ratingModal = {item: {id, title: `Saison ${s} √âp. ${e}`}, type: 'episode', epData: {s: parseInt(s), e: parseInt(e)}};
    render();
}

function confirmNote(n) {
    const m = state.ratingModal;
    if(m.type === 'movie') addToCollection(m.item, n);
    else noteEpisode(m.item.id, m.epData.s, m.epData.e, n);
}

function deleteItem(id) {
    if(confirm("Supprimer ?")) {
        state.collection = state.collection.filter(i => i.id !== id);
        save();
        render();
    }
}

fetchData();
</script>
</body>
</html>
