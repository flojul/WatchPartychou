<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Notre Cin√©th√®que</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior-y: contain; margin: 0; padding: 0; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="app"></div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBFN56hOHMO0yOOiKxFCr2hU6trRnqf3jQ",
            databaseURL: "https://watchpartychou-default-rtdb.europe-west1.firebasedatabase.app"
        };

        // √âtat global
        let appState = {
            view: 'home',
            collection: [],
            searchQuery: '',
            searchResults: [],
            isSearching: false,
            isLoading: true,
            selectedItem: null,
            showModal: false,
            modalRating: 0,
            expandedSeasons: {},
            episodeInputs: {}
        };

        // Charger la collection depuis Firebase
        async function loadCollection() {
            appState.isLoading = true;
            renderApp();
            try {
                const response = await fetch(firebaseConfig.databaseURL + '/collection.json');
                const data = await response.json();
                appState.collection = data || [];
                localStorage.setItem('cache', JSON.stringify(appState.collection));
            } catch (error) {
                console.error('Erreur:', error);
                const cache = localStorage.getItem('cache');
                if (cache) appState.collection = JSON.parse(cache);
            }
            appState.isLoading = false;
            renderApp();
        }

        // Sauvegarder la collection
        async function saveCollection() {
            try {
                await fetch(firebaseConfig.databaseURL + '/collection.json', {
                    method: 'PUT',
                    body: JSON.stringify(appState.collection)
                });
                localStorage.setItem('cache', JSON.stringify(appState.collection));
            } catch (error) {
                alert('Erreur de synchronisation');
            }
        }

        // Rechercher sur OMDb
        async function searchMovies() {
            if (!appState.searchQuery) return;
            appState.isSearching = true;
            appState.searchResults = [];
            renderApp();
            
            try {
                const response = await fetch(`https://www.omdbapi.com/?apikey=b9a5e69d&s=${encodeURIComponent(appState.searchQuery)}`);
                const data = await response.json();
                
                if (data.Response === 'True') {
                    const promises = data.Search.slice(0, 8).map(item =>
                        fetch(`https://www.omdbapi.com/?apikey=b9a5e69d&i=${item.imdbID}`)
                            .then(r => r.json())
                    );
                    appState.searchResults = await Promise.all(promises);
                }
            } catch (error) {
                console.error('Erreur recherche:', error);
            }
            
            appState.isSearching = false;
            renderApp();
        }

        // Ajouter √† la collection
        function addToCollection() {
            if (!appState.modalRating || !appState.selectedItem) return;
            
            const item = appState.selectedItem;
            const newItem = {
                imdbID: item.imdbID,
                Title: item.Title,
                Year: item.Year,
                Type: item.Type,
                Poster: item.Poster,
                Plot: item.Plot,
                totalSeasons: item.totalSeasons,
                ourRating: appState.modalRating,
                addedDate: new Date().toISOString(),
                seasons: null
            };

            if (item.Type === 'series' && item.totalSeasons) {
                newItem.seasons = [];
                for (let i = 1; i <= parseInt(item.totalSeasons); i++) {
                    newItem.seasons.push({ season: i, episodes: [] });
                }
            }

            appState.collection.unshift(newItem);
            saveCollection();
            appState.showModal = false;
            appState.selectedItem = null;
            appState.modalRating = 0;
            renderApp();
        }

        // Supprimer un item
        function deleteItem(imdbID) {
            if (confirm('Supprimer cet √©l√©ment ?')) {
                appState.collection = appState.collection.filter(i => i.imdbID !== imdbID);
                saveCollection();
                renderApp();
            }
        }

        // Toggle saison
        function toggleSeason(imdbID, seasonNum) {
            const key = imdbID + '-' + seasonNum;
            appState.expandedSeasons[key] = !appState.expandedSeasons[key];
            renderApp();
        }

        // Ajouter √©pisode
        function addEpisode(imdbID, seasonNum) {
            const key = imdbID + '-' + seasonNum;
            const input = appState.episodeInputs[key];
            if (!input || !input.episode || !input.rating) return;

            const item = appState.collection.find(i => i.imdbID === imdbID);
            if (!item || !item.seasons) return;

            const season = item.seasons[seasonNum - 1];
            const existingEp = season.episodes.find(e => e.episode === input.episode);
            
            if (existingEp) {
                existingEp.rating = input.rating;
            } else {
                season.episodes.push({
                    episode: input.episode,
                    rating: input.rating,
                    date: new Date().toISOString()
                });
                season.episodes.sort((a, b) => a.episode - b.episode);
            }

            appState.episodeInputs[key] = { episode: '', rating: 0 };
            saveCollection();
            renderApp();
        }

        // Calculer stats
        function getStats() {
            const movies = appState.collection.filter(i => i.Type === 'movie').length;
            const series = appState.collection.filter(i => i.Type === 'series').length;
            let episodes = 0;
            appState.collection.forEach(item => {
                if (item.seasons) {
                    item.seasons.forEach(s => episodes += s.episodes.length);
                }
            });
            return { movies, series, episodes };
        }

        // Cr√©er les √©toiles
        function createStars(rating, size, clickable, onClickPrefix) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= rating;
                const color = filled ? 'text-yellow-400' : 'text-gray-600';
                const click = clickable ? `onclick="${onClickPrefix}(${i})"` : '';
                const cursor = clickable ? 'cursor-pointer' : '';
                html += `<button ${click} class="inline-block ${color} ${cursor}" style="width:${size}px;height:${size}px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="${filled ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                </button>`;
            }
            return html;
        }

        // Rendu principal
        function renderApp() {
            const app = document.getElementById('app');
            
            if (appState.isLoading) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <div class="text-6xl mb-4">‚è≥</div>
                            <p class="text-xl">Chargement...</p>
                        </div>
                    </div>
                `;
                return;
            }

            const stats = getStats();

            app.innerHTML = `
                <!-- Navigation -->
                <nav class="bg-gray-800 p-4 sticky top-0 z-40 shadow-lg">
                    <div class="max-w-4xl mx-auto flex justify-between items-center">
                        <h1 class="text-xl md:text-2xl font-bold text-blue-400">Notre Cin√©th√®que</h1>
                        <div class="flex gap-2">
                            <button onclick="appState.view='home';renderApp()" 
                                    class="px-3 md:px-4 py-2 rounded text-sm md:text-base ${appState.view === 'home' ? 'bg-blue-600' : 'bg-gray-700'}">
                                Collection
                            </button>
                            <button onclick="appState.view='search';renderApp()" 
                                    class="px-3 md:px-4 py-2 rounded text-sm md:text-base ${appState.view === 'search' ? 'bg-blue-600' : 'bg-gray-700'}">
                                Rechercher
                            </button>
                            <button onclick="loadCollection()" class="p-2 hover:bg-gray-700 rounded">üîÑ</button>
                        </div>
                    </div>
                </nav>

                <!-- Contenu -->
                <div class="max-w-4xl mx-auto p-4">
                    ${appState.view === 'home' ? renderHome(stats) : renderSearch()}
                </div>

                <!-- Modal -->
                ${appState.showModal ? renderModal() : ''}
            `;
        }

        function renderHome(stats) {
            return `
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 md:p-6 rounded-xl">
                        <div class="text-2xl md:text-4xl mb-2">üé¨</div>
                        <div class="text-2xl md:text-3xl font-bold">${stats.movies}</div>
                        <div class="text-blue-200 text-xs md:text-sm">Films</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-600 to-purple-800 p-4 md:p-6 rounded-xl">
                        <div class="text-2xl md:text-4xl mb-2">üì∫</div>
                        <div class="text-2xl md:text-3xl font-bold">${stats.series}</div>
                        <div class="text-purple-200 text-xs md:text-sm">S√©ries</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-600 to-green-800 p-4 md:p-6 rounded-xl">
                        <div class="text-2xl md:text-4xl mb-2">üìä</div>
                        <div class="text-2xl md:text-3xl font-bold">${stats.episodes}</div>
                        <div class="text-green-200 text-xs md:text-sm">√âpisodes</div>
                    </div>
                </div>

                <h2 class="text-xl md:text-2xl font-bold mb-4">Historique</h2>
                
                ${appState.collection.length === 0 ? `
                    <div class="text-center py-12 text-gray-400">
                        <div class="text-6xl mb-4">üé¨</div>
                        <p class="text-lg md:text-xl">Collection vide</p>
                        <p class="text-sm mt-2">Recherchez un film ou s√©rie !</p>
                    </div>
                ` : appState.collection.map(item => `
                    <div class="bg-gray-800 rounded-lg p-4 mb-4">
                        <div class="flex gap-4">
                            <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22150%22%3E%3Crect fill=%22%23374151%22 width=%22100%22 height=%22150%22/%3E%3C/svg%3E'}" 
                                 alt="${item.Title}" class="w-16 md:w-20 h-24 md:h-28 object-cover rounded" />
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-base md:text-lg font-bold truncate">${item.Title}</h3>
                                        <p class="text-gray-400 text-xs md:text-sm">${item.Year} ‚Ä¢ ${item.Type === 'movie' ? 'Film' : 'S√©rie'}</p>
                                    </div>
                                    <button onclick="deleteItem('${item.imdbID}')" class="text-red-400 p-2 flex-shrink-0">üóëÔ∏è</button>
                                </div>
                                <div class="my-2">${createStars(item.ourRating, 16, false, '')}</div>
                                <p class="text-gray-300 text-xs md:text-sm line-clamp-2">${(item.Plot || '').substring(0, 150)}...</p>
                            </div>
                        </div>
                        ${item.seasons ? renderSeasons(item) : ''}
                    </div>
                `).join('')}
            `;
        }

        function renderSeasons(item) {
            return `
                <div class="mt-4 space-y-2">
                    ${item.seasons.map(season => {
                        const key = item.imdbID + '-' + season.season;
                        const isExpanded = appState.expandedSeasons[key];
                        const input = appState.episodeInputs[key] || { episode: '', rating: 0 };
                        
                        return `
                            <div class="bg-gray-700 rounded-lg overflow-hidden">
                                <button onclick="toggleSeason('${item.imdbID}', ${season.season})"
                                        class="w-full p-3 flex justify-between items-center hover:bg-gray-600">
                                    <span class="text-sm md:text-base font-semibold">Saison ${season.season} (${season.episodes.length} √©p.)</span>
                                    <span>${isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                                </button>
                                ${isExpanded ? `
                                    <div class="p-3 space-y-2">
                                        <div class="flex gap-2 items-center flex-wrap">
                                            <input type="number" 
                                                   value="${input.episode}" 
                                                   oninput="if(!appState.episodeInputs['${key}'])appState.episodeInputs['${key}']={episode:'',rating:0};appState.episodeInputs['${key}'].episode=parseInt(this.value);renderApp()"
                                                   placeholder="√âp." min="1"
                                                   class="w-16 bg-gray-600 text-white px-2 py-1 rounded text-sm" />
                                            <div class="flex gap-1">
                                                ${[1,2,3,4,5].map(i => `
                                                    <button onclick="if(!appState.episodeInputs['${key}'])appState.episodeInputs['${key}']={episode:'',rating:0};appState.episodeInputs['${key}'].rating=${i};renderApp()"
                                                            class="${input.rating >= i ? 'text-yellow-400' : 'text-gray-500'}">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="${input.rating >= i ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                                        </svg>
                                                    </button>
                                                `).join('')}
                                            </div>
                                            <button onclick="addEpisode('${item.imdbID}', ${season.season})"
                                                    class="bg-blue-600 text-white px-3 py-1 rounded text-sm ml-auto">
                                                Ajouter
                                            </button>
                                        </div>
                                        ${season.episodes.map(ep => `
                                            <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                                                <span class="text-sm">√âpisode ${ep.episode}</span>
                                                <div class="flex gap-1">
                                                    ${createStars(ep.rating, 14, false, '')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderSearch() {
            return `
                <div class="flex gap-2 mb-6">
                    <input type="text" 
                           value="${appState.searchQuery}" 
                           oninput="appState.searchQuery=this.value"
                           onkeypress="if(event.key==='Enter')searchMovies()"
                           placeholder="Rechercher..."
                           class="flex-1 bg-gray-800 text-white px-4 py-3 rounded-lg" />
                    <button onclick="searchMovies()" 
                            class="bg-blue-600 px-4 md:px-6 py-3 rounded-lg hover:bg-blue-700">
                        üîç
                    </button>
                </div>

                ${appState.isSearching ? '<p class="text-center text-gray-400">Recherche...</p>' : ''}

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${appState.searchResults.map(item => `
                        <div class="bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-600"
                             onclick="appState.selectedItem=${JSON.stringify(item).replace(/"/g, '&quot;')};appState.showModal=true;appState.modalRating=0;renderApp()">
                            <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect fill=%22%23374151%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'}" 
                                 alt="${item.Title}" class="w-full h-48 md:h-64 object-cover" />
                            <div class="p-3">
                                <h3 class="font-semibold text-sm truncate">${item.Title}</h3>
                                <p class="text-gray-400 text-xs">${item.Year}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderModal() {
            const item = appState.selectedItem;
            return `
                <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" 
                     onclick="if(event.target===this){appState.showModal=false;renderApp()}">
                    <div class="bg-gray-800 rounded-xl p-6 max-w-md w-full">
                        <div class="flex justify-between mb-4">
                            <h3 class="text-lg md:text-xl font-bold">${item.Title}</h3>
                            <button onclick="appState.showModal=false;renderApp()" class="text-gray-400">‚úï</button>
                        </div>
                        <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect fill=%22%23374151%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'}" 
                             alt="${item.Title}" class="w-full h-48 object-cover rounded mb-4" />
                        <p class="text-gray-400 text-sm mb-4">${item.Year} ‚Ä¢ ${item.Type === 'movie' ? 'Film' : 'S√©rie'}</p>
                        <div class="mb-6">
                            <p class="mb-2">Votre note :</p>
                            <div class="flex gap-2">
                                ${createStars(appState.modalRating, 32, true, 'setModalRating')}
                            </div>
                        </div>
                        <button onclick="addToCollection()" 
                                ${!appState.modalRating ? 'disabled' : ''}
                                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            Ajouter
                        </button>
                    </div>
                </div>
            `;
        }

        function setModalRating(rating) {
            appState.modalRating = rating;
            renderApp();
        }

        // Initialisation
        loadCollection();
        setInterval(loadCollection, 30000);
    </script>
</body>
</html>
