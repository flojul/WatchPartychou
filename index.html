
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WatchParty Pro üé¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #a855f7; }
        body { background-color: #0f172a; color: #f1f5f9; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #a855f7, #ec4899); transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .log-panel { font-family: 'Courier New', monospace; font-size: 10px; background: #000; color: #4ade80; max-height: 100px; overflow-y: auto; padding: 10px; border-bottom: 1px solid #334155; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .card-enter { animation: scaleUp 0.3s ease-out; }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="selection:bg-purple-500/30">

<div id="app"></div>

<script>
// CONFIGURATION
const DB_URL = "https://watchpartychou-default-rtdb.europe-west1.firebasedatabase.app/collection.json";
// Utilisation d'un endpoint OMDB s√©curis√© (HTTPS indispensable pour GitHub Pages)
const SEARCH_API = "https://www.omdbapi.com/?apikey=b9a5e69d";

let state = {
    view: 'films',
    filter: 'recent',
    query: '',
    results: [],
    collection: [],
    loading: true,
    searching: false,
    showLogs: false,
    logs: [],
    ratingModal: null 
};

function addLog(m) {
    state.logs.unshift(`[${new Date().toLocaleTimeString()}] ${m}`);
    render();
}

// LOGIQUE DONN√âES
async function sync() {
    try {
        const r = await fetch(DB_URL);
        const data = await r.json();
        state.collection = data || [];
        addLog("Synchronisation r√©ussie (" + state.collection.length + " items)");
    } catch (e) { addLog("Erreur Sync: " + e.message); }
    state.loading = false;
    render();
}

async function save() {
    try {
        await fetch(DB_URL, { method: 'PUT', body: JSON.stringify(state.collection) });
    } catch (e) { addLog("Erreur Sauvegarde: " + e.message); }
}

// RECHERCHE (Correction du "Failed to Fetch")
async function search() {
    if(!state.query.trim()) return;
    state.searching = true;
    render();
    addLog("Appel API recherche...");
    
    try {
        // Ajout du param√®tre &type pour filtrer si n√©cessaire ou laisser tel quel
        const r = await fetch(`${SEARCH_API}&s=${encodeURIComponent(state.query)}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        
        if (data.Response === "True") {
            state.results = data.Search;
            addLog(data.Search.length + " r√©sultats trouv√©s");
        } else {
            state.results = [];
            addLog("API: " + data.Error);
        }
    } catch (e) {
        addLog("Erreur fatale: " + e.message + ". V√©rifiez votre connexion.");
    }
    state.searching = false;
    render();
}

// UI HELPERS
function getProgression(item) {
    if (item.Type !== 'series') return 0;
    // On base la progression sur un objectif de 20 √©pisodes pour le 100%
    // Ou on peut stocker le total d'√©pisodes s'il est dispo dans l'item
    const count = item.episodes ? item.episodes.length : 0;
    return Math.min((count / 20) * 100, 100);
}

function render() {
    const root = document.getElementById('app');
    if(state.loading) {
        root.innerHTML = `<div class="h-screen flex items-center justify-center"><div class="animate-spin text-4xl">üé¨</div></div>`;
        return;
    }

    let items = state.collection.filter(i => state.view === 'films' ? i.Type === 'movie' : i.Type === 'series');
    if(state.filter === 'rating') items.sort((a,b) => b.ourRating - a.ourRating);
    else items.sort((a,b) => b.addedAt - a.addedAt);

    root.innerHTML = `
        ${state.showLogs ? `<div class="log-panel">${state.logs.map(l=>`<div>${l}</div>`).join('')}</div>` : ''}
        
        <header class="glass sticky top-0 z-50 p-4 flex justify-between items-center border-b border-white/5">
            <h1 class="font-black italic text-2xl bg-gradient-to-r from-purple-400 to-pink-500 bg-clip-text text-transparent">WATCHPARTY</h1>
            <div class="flex gap-3">
                <button onclick="state.showLogs=!state.showLogs;render()" class="opacity-30 text-[10px]">DEBUG</button>
                <button onclick="sync()" class="text-xl">üîÑ</button>
            </div>
        </header>

        <nav class="flex p-4 gap-2 overflow-x-auto no-scrollbar bg-slate-900/50">
            ${['films', 'series', 'search'].map(v => `
                <button onclick="state.view='${v}';render()" 
                    class="px-6 py-2.5 rounded-2xl text-xs font-bold transition-all whitespace-nowrap
                    ${state.view === v ? 'bg-purple-600 shadow-lg shadow-purple-500/20 text-white' : 'bg-slate-800 text-slate-400'}">
                    ${v.toUpperCase()}
                </button>
            `).join('')}
        </nav>

        <main class="p-4 pb-32">
            ${state.view === 'search' ? renderSearch() : `
                <div class="flex gap-6 mb-6 px-1">
                    <button onclick="state.filter='recent';render()" class="text-xs font-black ${state.filter==='recent'?'text-purple-400':'text-slate-600'}">R√âCENTS</button>
                    <button onclick="state.filter='rating';render()" class="text-xs font-black ${state.filter==='rating'?'text-purple-400':'text-slate-600'}">TOP NOTES</button>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    ${items.map(renderCard).join('')}
                </div>
            `}
        </main>

        ${state.ratingModal ? renderRatingModal() : ''}
    `;
}

function renderCard(item) {
    const prog = getProgression(item);
    return `
        <div class="glass rounded-3xl overflow-hidden flex flex-col card-enter">
            <div class="relative aspect-[2/3]">
                <img src="${item.Poster}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent p-4 flex flex-col justify-end">
                    <div class="flex gap-0.5 text-yellow-400 text-[10px]">
                        ${'‚òÖ'.repeat(item.ourRating)}${'‚òÜ'.repeat(5-item.ourRating)}
                    </div>
                </div>
                <button onclick="deleteItem('${item.imdbID}')" class="absolute top-2 right-2 w-8 h-8 flex items-center justify-center bg-black/20 backdrop-blur-md rounded-full text-xs">‚úï</button>
            </div>
            <div class="p-3">
                <h3 class="text-[11px] font-bold truncate mb-2 uppercase tracking-tight">${item.Title}</h3>
                ${item.Type === 'series' ? `
                    <div class="progress-bar mb-1"><div class="progress-fill" style="width:${prog}%"></div></div>
                    <div class="flex justify-between text-[9px] font-bold text-slate-500 mb-3">
                        <span>${item.episodes?.length || 0} √âPISODES</span>
                        <span>${Math.round(prog)}%</span>
                    </div>
                    <button onclick="openNoteEp('${item.imdbID}')" class="w-full py-2 bg-purple-500/10 text-purple-400 rounded-xl text-[10px] font-black border border-purple-500/20">+ √âPISODE</button>
                ` : `
                   <button onclick="openNoteItem('${item.imdbID}')" class="w-full py-2 bg-white/5 text-slate-400 rounded-xl text-[10px] font-black">RE-NOTER</button>
                `}
            </div>
        </div>
    `;
}

function renderSearch() {
    return `
        <div class="flex gap-2 mb-6">
            <input type="text" value="${state.query}" oninput="state.query=this.value" onkeypress="if(event.key==='Enter')search()" 
                class="flex-1 bg-slate-800/80 border border-white/5 rounded-2xl px-5 py-4 outline-none focus:ring-2 ring-purple-500 transition-all" 
                placeholder="Nom du film ou s√©rie...">
            <button onclick="search()" class="bg-purple-600 px-6 rounded-2xl font-bold shadow-lg shadow-purple-500/30">üîç</button>
        </div>
        <div class="grid grid-cols-2 gap-4">
            ${state.results.map(r => `
                <div onclick="openNoteItem('${r.imdbID}', ${JSON.stringify(r).replace(/"/g, '&quot;')})" 
                    class="glass p-2 rounded-2xl text-center active:scale-95 transition-transform">
                    <img src="${r.Poster}" class="rounded-xl aspect-[2/3] object-cover mb-3" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">
                    <div class="text-[10px] font-bold truncate px-1">${r.Title}</div>
                    <div class="text-[9px] text-purple-400 font-bold mt-1 mb-2">AJOUTER</div>
                </div>
            `).join('')}
        </div>
        ${state.searching ? '<div class="text-center p-12 animate-bounce text-2xl">üé¨</div>' : ''}
    `;
}

function renderRatingModal() {
    return `
        <div class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-black/60 backdrop-blur-sm card-enter">
            <div class="bg-slate-900 border border-white/10 w-full max-w-sm rounded-[32px] p-8 shadow-2xl">
                <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-6 sm:hidden"></div>
                <h2 class="text-center font-black text-lg mb-2 uppercase tracking-tight">${state.ratingModal.title}</h2>
                <p class="text-center text-[10px] text-slate-500 mb-8 font-bold uppercase tracking-widest">Quelle est votre note ?</p>
                <div class="flex justify-center gap-3 mb-10">
                    ${[1,2,3,4,5].map(n => `
                        <button onclick="confirmRating(${n})" 
                            class="w-12 h-12 rounded-2xl bg-slate-800 flex items-center justify-center text-xl hover:bg-purple-600 transition-colors">
                            ${n}
                        </button>
                    `).join('')}
                </div>
                <button onclick="state.ratingModal=null;render()" class="w-full py-4 text-xs text-slate-400 font-black uppercase tracking-widest">Annuler</button>
            </div>
        </div>
    `;
}

// ACTIONS LOGIQUE
function openNoteItem(id, itemData = null) {
    const item = itemData || state.collection.find(i => i.imdbID === id);
    state.ratingModal = { title: item.Title, id: id, data: item, type: 'main' };
    render();
}

function openNoteEp(id) {
    const s = prompt("Saison ?", "1");
    const e = prompt("√âpisode ?", "1");
    if(s && e) {
        state.ratingModal = { 
            title: `Saison ${s} ‚Ä¢ √âp. ${e}`, 
            id: id, 
            type: 'episode', 
            epData: { s: parseInt(s), e: parseInt(e) } 
        };
        render();
    }
}

function confirmRating(n) {
    const m = state.ratingModal;
    if(m.type === 'main') {
        const idx = state.collection.findIndex(i => i.imdbID === m.id);
        if(idx === -1) {
            state.collection.unshift({
                ...m.data,
                ourRating: n,
                addedAt: Date.now(),
                episodes: []
            });
        } else {
            state.collection[idx].ourRating = n;
        }
    } else {
        const item = state.collection.find(i => i.imdbID === m.id);
        if(item) {
            if(!item.episodes) item.episodes = [];
            item.episodes.push({ s: m.epData.s, e: m.epData.e, r: n });
        }
    }
    save();
    state.ratingModal = null;
    render();
}

function deleteItem(id) {
    if(confirm("Supprimer cet √©l√©ment ?")) {
        state.collection = state.collection.filter(i => i.imdbID !== id);
        save();
        render();
    }
}

// INITIALISATION
sync();
</script>
</body>
</html>
