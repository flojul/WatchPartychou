<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>WatchParty üé¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .fade-in-scale { animation: fadeInScale 0.3s ease-out forwards; }
        .slide-up { animation: slideInUp 0.4s ease-out forwards; }
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }
        .glass-effect {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .shimmer {
            background: linear-gradient(90deg, #1e293b 0%, #334155 50%, #1e293b 100%);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
        * { -webkit-tap-highlight-color: transparent; }
        body { overscroll-behavior: contain; }
        .star-btn {
            transition: transform 0.2s, color 0.2s;
        }
        .star-btn:active {
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
    <div id="app"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBFN56hOHMO0yOOiKxFCr2hU6trRnqf3jQ",
            databaseURL: "https://watchpartychou-default-rtdb.europe-west1.firebasedatabase.app"
        };

        let appState = {
            view: 'films',
            collection: [],
            searchQuery: '',
            searchResults: [],
            isSearching: false,
            isLoading: true,
            selectedItem: null,
            showModal: false,
            modalRating: 0,
            showRatingPopup: false,
            ratingItem: null,
            ratingType: 'movie',
            episodeData: null
        };

        async function loadCollection() {
            appState.isLoading = true;
            render();
            try {
                const response = await fetch(firebaseConfig.databaseURL + '/collection.json');
                const data = await response.json();
                appState.collection = data || [];
                localStorage.setItem('cache', JSON.stringify(appState.collection));
            } catch (error) {
                const cache = localStorage.getItem('cache');
                if (cache) appState.collection = JSON.parse(cache);
            }
            appState.isLoading = false;
            render();
        }

        async function saveCollection() {
            try {
                await fetch(firebaseConfig.databaseURL + '/collection.json', {
                    method: 'PUT',
                    body: JSON.stringify(appState.collection)
                });
                localStorage.setItem('cache', JSON.stringify(appState.collection));
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function searchMovies() {
            if (!appState.searchQuery) return;
            appState.isSearching = true;
            appState.searchResults = [];
            render();
            
            try {
                const response = await fetch(`https://www.omdbapi.com/?apikey=b9a5e69d&s=${encodeURIComponent(appState.searchQuery)}`);
                const data = await response.json();
                
                if (data.Response === 'True') {
                    const promises = data.Search.slice(0, 12).map(item =>
                        fetch(`https://www.omdbapi.com/?apikey=b9a5e69d&i=${item.imdbID}`)
                            .then(r => r.json())
                    );
                    appState.searchResults = await Promise.all(promises);
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
            
            appState.isSearching = false;
            render();
        }

        function openRatingPopup(item, type = 'movie', episodeData = null) {
            appState.ratingItem = item;
            appState.ratingType = type;
            appState.episodeData = episodeData;
            appState.modalRating = 0;
            appState.showRatingPopup = true;
            render();
        }

        function submitRating() {
            if (!appState.modalRating) return;

            const item = appState.ratingItem;

            if (appState.ratingType === 'movie') {
                // Ajouter un film
                const exists = appState.collection.find(i => i.imdbID === item.imdbID);
                if (!exists) {
                    const newItem = {
                        imdbID: item.imdbID,
                        Title: item.Title,
                        Year: item.Year,
                        Type: item.Type,
                        Poster: item.Poster,
                        Plot: item.Plot,
                        totalSeasons: item.totalSeasons,
                        ourRating: appState.modalRating,
                        addedDate: new Date().toISOString(),
                        seasons: item.Type === 'series' && item.totalSeasons ? 
                            Array.from({ length: parseInt(item.totalSeasons) }, (_, i) => ({
                                season: i + 1,
                                episodes: []
                            })) : null
                    };
                    appState.collection.unshift(newItem);
                } else {
                    exists.ourRating = appState.modalRating;
                }
            } else if (appState.ratingType === 'episode') {
                // Ajouter note √©pisode
                const seriesItem = appState.collection.find(i => i.imdbID === item.imdbID);
                if (seriesItem && seriesItem.seasons) {
                    const season = seriesItem.seasons[appState.episodeData.season - 1];
                    const existingEp = season.episodes.find(e => e.episode === appState.episodeData.episode);
                    
                    if (existingEp) {
                        existingEp.rating = appState.modalRating;
                    } else {
                        season.episodes.push({
                            episode: appState.episodeData.episode,
                            rating: appState.modalRating,
                            date: new Date().toISOString()
                        });
                        season.episodes.sort((a, b) => a.episode - b.episode);
                    }
                }
            }

            saveCollection();
            appState.showRatingPopup = false;
            appState.modalRating = 0;
            render();
        }

        function deleteItem(imdbID) {
            if (confirm('Supprimer cet √©l√©ment ?')) {
                appState.collection = appState.collection.filter(i => i.imdbID !== imdbID);
                saveCollection();
                render();
            }
        }

        function createStars(rating, size = 24, clickable = false) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                const filled = i <= rating;
                const color = filled ? 'text-yellow-400' : 'text-slate-600';
                const click = clickable ? `onclick="appState.modalRating=${i};render()"` : '';
                html += `
                    <button ${click} class="star-btn ${color} ${clickable ? 'cursor-pointer' : ''}" style="width:${size}px;height:${size}px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="${filled ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                    </button>
                `;
            }
            return html;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (appState.isLoading) {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center fade-in">
                            <div class="text-8xl mb-6 animate-pulse">üé¨</div>
                            <div class="shimmer h-2 w-64 rounded-full mx-auto"></div>
                            <p class="text-xl mt-6 text-slate-300">Chargement de votre collection...</p>
                        </div>
                    </div>
                `;
                return;
            }

            const movies = appState.collection.filter(i => i.Type === 'movie');
            const series = appState.collection.filter(i => i.Type === 'series');

            app.innerHTML = `
                <!-- Header -->
                <header class="glass-effect sticky top-0 z-50 border-b border-white/10">
                    <div class="max-w-7xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl md:text-3xl font-bold gradient-text flex items-center gap-3">
                                üé¨ WatchParty
                            </h1>
                            <button onclick="loadCollection()" class="glass-effect px-4 py-2 rounded-xl hover:bg-white/10 transition-all">
                                <span class="text-xl">üîÑ</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- Navigation Tabs -->
                <div class="max-w-7xl mx-auto px-4 mt-6">
                    <div class="glass-effect rounded-2xl p-2 inline-flex gap-2">
                        <button onclick="appState.view='films';render()" 
                                class="px-6 py-3 rounded-xl font-semibold transition-all ${appState.view === 'films' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg' : 'hover:bg-white/5'}">
                            üé¨ Films (${movies.length})
                        </button>
                        <button onclick="appState.view='series';render()" 
                                class="px-6 py-3 rounded-xl font-semibold transition-all ${appState.view === 'series' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg' : 'hover:bg-white/5'}">
                            üì∫ S√©ries (${series.length})
                        </button>
                        <button onclick="appState.view='search';render()" 
                                class="px-6 py-3 rounded-xl font-semibold transition-all ${appState.view === 'search' ? 'bg-gradient-to-r from-purple-600 to-pink-600 shadow-lg' : 'hover:bg-white/5'}">
                            üîç Rechercher
                        </button>
                    </div>
                </div>

                <!-- Content -->
                <main class="max-w-7xl mx-auto px-4 py-8">
                    ${appState.view === 'search' ? renderSearch() : renderCollection()}
                </main>

                <!-- Rating Popup -->
                ${appState.showRatingPopup ? renderRatingPopup() : ''}
            `;
        }

        function renderSearch() {
            return `
                <div class="fade-in">
                    <div class="glass-effect rounded-2xl p-6 mb-8">
                        <div class="flex gap-3">
                            <input type="text" 
                                   value="${appState.searchQuery}" 
                                   oninput="appState.searchQuery=this.value"
                                   onkeypress="if(event.key==='Enter')searchMovies()"
                                   placeholder="Rechercher un film ou une s√©rie..."
                                   class="flex-1 bg-slate-800/50 text-white px-6 py-4 rounded-xl border border-white/10 focus:border-purple-500 focus:outline-none transition-all text-lg" />
                            <button onclick="searchMovies()" 
                                    class="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-4 rounded-xl font-semibold hover:shadow-xl transition-all">
                                üîç Rechercher
                            </button>
                        </div>
                    </div>

                    ${appState.isSearching ? `
                        <div class="text-center py-20">
                            <div class="shimmer h-4 w-48 rounded mx-auto mb-4"></div>
                            <div class="shimmer h-4 w-64 rounded mx-auto"></div>
                        </div>
                    ` : ''}

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-6">
                        ${appState.searchResults.map((item, i) => `
                            <div class="fade-in card-hover" style="animation-delay: ${i * 0.05}s">
                                <div class="glass-effect rounded-2xl overflow-hidden group cursor-pointer"
                                     onclick="openRatingPopup(${JSON.stringify(item).replace(/"/g, '&quot;')}, 'movie')">
                                    <div class="relative aspect-[2/3] overflow-hidden">
                                        <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect fill=%22%23334155%22 width=%22200%22 height=%22300%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23cbd5e1%22 font-size=%2240%22%3Eüé¨%3C/text%3E%3C/svg%3E'}" 
                                             alt="${item.Title}" 
                                             class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                        <div class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-300">
                                            <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-2 rounded-lg text-center font-semibold">
                                                ‚ûï Ajouter
                                            </div>
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <h3 class="font-bold text-sm mb-1 line-clamp-2">${item.Title}</h3>
                                        <p class="text-slate-400 text-xs">${item.Year} ‚Ä¢ ${item.Type === 'movie' ? 'Film' : 'S√©rie'}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCollection() {
            const items = appState.view === 'films' 
                ? appState.collection.filter(i => i.Type === 'movie')
                : appState.collection.filter(i => i.Type === 'series');

            if (items.length === 0) {
                return `
                    <div class="text-center py-20 fade-in">
                        <div class="text-8xl mb-6">${appState.view === 'films' ? 'üé¨' : 'üì∫'}</div>
                        <h2 class="text-3xl font-bold mb-4">Aucun ${appState.view === 'films' ? 'film' : 's√©rie'}</h2>
                        <p class="text-slate-400 text-lg mb-8">Commencez par rechercher et ajouter vos favoris !</p>
                        <button onclick="appState.view='search';render()" 
                                class="bg-gradient-to-r from-purple-600 to-pink-600 px-8 py-4 rounded-xl font-semibold hover:shadow-xl transition-all">
                            üîç Rechercher
                        </button>
                    </div>
                `;
            }

            return `
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    ${items.map((item, i) => `
                        <div class="fade-in" style="animation-delay: ${i * 0.05}s">
                            ${appState.view === 'films' ? renderMovieCard(item) : renderSeriesCard(item)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMovieCard(item) {
            return `
                <div class="glass-effect rounded-2xl overflow-hidden group card-hover">
                    <div class="relative aspect-[2/3]">
                        <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect fill=%22%23334155%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'}" 
                             alt="${item.Title}" 
                             class="w-full h-full object-cover" />
                        <div class="absolute top-3 right-3">
                            <button onclick="deleteItem('${item.imdbID}')" 
                                    class="bg-red-500/90 backdrop-blur-sm p-2 rounded-full hover:bg-red-600 transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                            <div class="flex items-center justify-between mb-2">
                                ${item.ourRating ? 
                                    `<div class="flex gap-1">${createStars(item.ourRating, 16)}</div>` :
                                    `<span class="text-xs text-slate-400 italic">Non not√©</span>`
                                }
                                <button onclick="openRatingPopup(${JSON.stringify(item).replace(/"/g, '&quot;')}, 'movie')"
                                        class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-sm hover:bg-white/30 transition-all">
                                    ‚≠ê Noter
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-1 line-clamp-2">${item.Title}</h3>
                        <p class="text-slate-400 text-sm">${item.Year}</p>
                    </div>
                </div>
            `;
        }

        function renderSeriesCard(item) {
            const totalEpisodes = item.seasons ? item.seasons.reduce((sum, s) => sum + s.episodes.length, 0) : 0;
            
            return `
                <div class="glass-effect rounded-2xl overflow-hidden card-hover">
                    <div class="relative aspect-[2/3]">
                        <img src="${item.Poster !== 'N/A' ? item.Poster : 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22300%22%3E%3Crect fill=%22%23334155%22 width=%22200%22 height=%22300%22/%3E%3C/svg%3E'}" 
                             alt="${item.Title}" 
                             class="w-full h-full object-cover" />
                        <div class="absolute top-3 right-3">
                            <button onclick="deleteItem('${item.imdbID}')" 
                                    class="bg-red-500/90 backdrop-blur-sm p-2 rounded-full hover:bg-red-600 transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 to-transparent">
                            ${item.ourRating ? 
                                `<div class="flex gap-1 mb-2">${createStars(item.ourRating, 16)}</div>` :
                                `<span class="text-xs text-slate-400 italic mb-2 block">Non not√©</span>`
                            }
                            <button onclick="openRatingPopup(${JSON.stringify(item).replace(/"/g, '&quot;')}, 'movie')"
                                    class="bg-white/20 backdrop-blur-sm w-full py-2 rounded-full text-sm hover:bg-white/30 transition-all mb-2">
                                ‚≠ê Noter la s√©rie
                            </button>
                        </div>
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold mb-2 line-clamp-2">${item.Title}</h3>
                        <p class="text-slate-400 text-sm mb-3">${item.Year}</p>
                        
                        ${item.seasons ? `
                            <div class="space-y-2">
                                ${item.seasons.map(season => `
                                    <details class="glass-effect rounded-lg overflow-hidden">
                                        <summary class="px-3 py-2 cursor-pointer hover:bg-white/5 flex justify-between items-center">
                                            <span class="text-sm font-semibold">Saison ${season.season}</span>
                                            <span class="text-xs text-slate-400">${season.episodes.length} √©p.</span>
                                        </summary>
                                        <div class="p-3 space-y-2 bg-slate-900/50">
                                            <div class="flex gap-2 mb-3">
                                                <input type="number" 
                                                       id="ep-${item.imdbID}-${season.season}" 
                                                       placeholder="N¬∞ √©p." 
                                                       min="1"
                                                       class="w-20 bg-slate-800 px-3 py-2 rounded-lg text-sm border border-white/10" />
                                                <button onclick="const ep=document.getElementById('ep-${item.imdbID}-${season.season}').value;if(ep){openRatingPopup(${JSON.stringify(item).replace(/"/g, '&quot;')}, 'episode', {season:${season.season},episode:parseInt(ep)})}"
                                                        class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 py-2 rounded-lg text-sm font-semibold">
                                                    ‚ûï Noter √©pisode
                                                </button>
                                            </div>
                                            ${season.episodes.map(ep => `
                                                <div class="flex justify-between items-center bg-slate-800/50 px-3 py-2 rounded-lg">
                                                    <span class="text-sm">√âp. ${ep.episode}</span>
                                                    <div class="flex gap-1">${createStars(ep.rating, 14)}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </details>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderRatingPopup() {
            const item = appState.ratingItem;
            const isEpisode = appState.ratingType === 'episode';
            
            return `
                <div class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in" 
                     onclick="if(event.target===this){appState.showRatingPopup=false;render()}">
                    <div class="glass-effect rounded-3xl p-8 max-w-md w-full slide-up border border-white/20">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-2xl font-bold mb-2">${item.Title}</h3>
                                ${isEpisode ? `
                                    <p class="text-purple-400 font-semibold">Saison ${appState.episodeData.season} ‚Ä¢ √âpisode ${appState.episodeData.episode}</p>
                                ` : `
                                    <p class="text-slate-400">${item.Year}</p>
                                `}
                            </div>
                            <button onclick="appState.showRatingPopup=false;render()" 
                                    class="text-slate-400 hover:text-white text-2xl">
                                ‚úï
                            </button>
                        </div>
                        
                        <div class="mb-8">
                            <p class="text-lg mb-4 text-center">Votre note</p>
                            <div class="flex justify-center gap-3 mb-6">
                                ${createStars(appState.modalRating, 40, true)}
                            </div>
                            ${appState.modalRating > 0 ? `
                                <p class="text-center text-slate-300">
                                    ${['', 'Pas terrible', 'Moyen', 'Bien', 'Tr√®s bien', 'Chef-d\'≈ìuvre !'][appState.modalRating]}
                                </p>
                            ` : ''}
                        </div>
                        
                        <button onclick="submitRating()" 
                                ${!appState.modalRating ? 'disabled' : ''}
                                class="w-full bg-gradient-to-r from-purple-600 to-pink-600 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                            Valider la note
                        </button>
                    </div>
                </div>
            `;
        }

        // Init
        loadCollection();
        setInterval(loadCollection, 30000);
    </script>
</body>
</html>
